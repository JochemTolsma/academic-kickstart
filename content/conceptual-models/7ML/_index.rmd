---
title: Multilevel
author: JochemTolsma
date: '2020-12-07'
slug: ml7
categories:
  - R
  - Conceptual Models
tags: []
#linktitle:

summary: "conceptual model, moderation, multi-level, explanation, tutorial, R, Lavaan"
lastmod: '`r format(Sys.Date(), "%d-%m-%Y")`'

type: book
weight: 70

output:
  blogdown::html_page:
    highlight: default
    number_sections: no
    self_contained: no
    toc: true
    fig_width: 6
    dev: "svg"
    
# add bibliography
#bibliography: my-library.bib
---

 
<!--set global settings--> 
```{r, globalsettings, echo=FALSE, warning=FALSE}
library(knitr)
opts_chunk$set(tidy.opts=list(width.cutoff=100),tidy=TRUE, warning = FALSE, message = FALSE, cache=TRUE, attr.source = ".numberLines", class.source="highlightt", results= "hold")
options(width = 100)
```
 

<!--copy to clipboard -->
```{r klippy, echo=FALSE, include=TRUE}
require(klippy)
klippy::klippy(position = c('top', 'left'))
#klippy::klippy(color = 'darkred')
#klippy::klippy(tooltip_message = 'Click to copy', tooltip_success = 'Done')
```

 

<!---
https://www.w3schools.com/w3css/w3css_buttons.asp
https://www.freecodecamp.org/news/a-quick-guide-to-styling-buttons-using-css-f64d4f96337f/
--->

<!---
<style>
.btn-text-right{
	text-align: right;
}
</style>

<div class="btn-text-right">
<button onclick="window.location.href='static/index.Rmd';">download .Rmd </button>  
</div>

--->

## The Conceptual Model  

### Version 1 

```{r, echo=FALSE, out.width = '100%', fig.cap="Multi-level model"}
knitr::include_graphics("../static/CM7a.PNG")
```
The independent variable **$X_2$** is measured at the macro-level (e.g. neighborhood) and impacts the dependent variable, **Y**, measured at the micro-level (e.g. neighborhood residents). The independent variable **$X_1$** is measured at the micro-level and impacts the dependent variable, **Y**, as well.  



---

### Version 2 (preferred)

```{r, echo=FALSE, fig.cap="Multi-level model (version 2)", out.width = '100%'}
knitr::include_graphics("../static/CM7b.PNG")
```

Please note that the independent variable at the macro-level **$X_2$** will impact all individuals within the same macro-level unit equally. Hence, it impacts the mean score of Y within a macro-level unit. To make it more concrete, a country-level variable like National Income may impact the mean health level of individuals within a country. National Income explains between-country variance in health, not within-country variance in health. To make this more explicit, I recommend you to use the conceptual model above. 

---  

### Version 3 (subscripts)


```{r, echo=FALSE, fig.cap="Multi-level model (version 3)", out.width = '100%'}
knitr::include_graphics("../static/CM7c.PNG")
```

Unfortunately, readers who look at version 2 may now think you have two different dependent variables, one at the micro-level and one at the macro-level. You could add subscripts to make more explicit what you mean.   
In the figure above we make explicit that we have a dependent variable, Y, that is measured at the micro-level. We explain (between-level) variance in mean scores of Y at the macro-level. The subscript *j* indexes the different macro-level units. *$Y_{.j}$* is shorthand notation for mean score of $Y_{ij}$ for unit *j*.  
At the micro-level we explain (within-level) variance in deviation-scores from the macro-level unit mean.  
The subscripts for the independent variables make clear we have two independent variables, one measured at the macro-level and one measures at the micro-level.  

In my experience, readers who do not immediately grasp version 2 don't understand version 3 either. I would therefore recommend sticking to version 2 and perhaps add *between* and *within* in the boxes. Add a note to your conceptual model and explain in words what you mean with your labels. 

---  

### Independent micro-level variable

```{r, echo=FALSE, fig.cap="Multi-level model (version 3)", out.width = '100%'}
knitr::include_graphics("../static/CM7d.PNG")
```

So far, we only made explicit that our dependent variable (measured at the micro-level) can be split in a within and between component. But the same holds true for independent variables measured at the micro-level.  

Independent variables measured at the micro-level may impact:  

1. **within macro-unit level variation** in the dependent variable  
2. **between macro-unit level variation** in the dependent variable  

Ad1: The between macro-level unit variation in the IV may be related to the between macro-level unit variation in the DV. Stated otherwise, the mean score of our IV across the macro-level units may be related to the mean scores of our DV across the macro-level units. This is path *b* in the figure above.  
Ad2: The within macro-level unit variation in the IV may be related to the within macro-level unit variation in the DV. This is path *a* in the figure above. 

Normally, path *b* is forgotten. Drawing a conceptual model may help you to remember to at least consider this possible pathway. If you do not include this relationship you are actually implicitly assuming that path *a* and *b* are the same. If this is not the case your estimation of path *a* will be biased.  

{{% alert warning %}}
**Composition effect:**
It could be possible that path *b* is not significant but that between-unit variation in your dependent variable is still explained after inclusion of your independent variable measured at the micro-level. This is then because of a so-called composition effect: the macro-level units harbor different micro-level units (e.g. some neighborhoods harbor more high income residents than others.)  

**Random samples:**
To estimate unbiased estimates it is important that you have excess to a random sample of macro-level units (not only high-income neighborhoods) and random samples of micro-level units within each macro-level unit. If the latter is not the case, for example when you sampled relatively rich residents of poor neighborhoods and relatively poor residents of rich neighborhoods, the (estimated or constructed) variable $X_{.j}$ will not be a valid measure for the true mean value of all $X_{ij}$ in neighborhood *j*. 

{{% /alert %}}


---  


{{% alert %}}
**work in progress**
{{% /alert %}}

---  


---  

---  


## Explanation  




---  

## Abstract hypotheses  



---  

## Real life example  


---  

## Structural equations   


---  

## Formal test of hypotheses  

Load the NELLS data.  

```{r}
rm(list=ls()) #empty environment
require(haven)
nells <- read_dta("../static/NELLS panel nl v1_2.dta") #change directory name to your working directory
```

Operationalize concepts. Please note that I mean center the covariates for ease of interpretation!

```{r, echo=FALSE, eval=FALSE}
# We will use the data of wave 2.
nellsw2<- nells[nells$w2cpanel==1,]

# As an indicator of occupational success we will use income in wave 2.
table(nellsw2$w2fa61, useNA="always")
attributes(nellsw2$w2fa61)
#recode (I will start newly created variables with cm from conceptual models)
nellsw2$cm_income <- nellsw2$w2fa61
nellsw2$cm_income[nellsw2$cm_income==1] <- 100
nellsw2$cm_income[nellsw2$cm_income==2] <- 225
nellsw2$cm_income[nellsw2$cm_income==3] <- 400
nellsw2$cm_income[nellsw2$cm_income==4] <- 750
nellsw2$cm_income[nellsw2$cm_income==5] <- 1250
nellsw2$cm_income[nellsw2$cm_income==6] <- 1750
nellsw2$cm_income[nellsw2$cm_income==7] <- 2250
nellsw2$cm_income[nellsw2$cm_income==8] <- 2750
nellsw2$cm_income[nellsw2$cm_income==9] <- 3250
nellsw2$cm_income[nellsw2$cm_income==10] <- 3750
nellsw2$cm_income[nellsw2$cm_income==11] <- 4250
nellsw2$cm_income[nellsw2$cm_income==12] <- 4750
nellsw2$cm_income[nellsw2$cm_income==13] <- 5250
nellsw2$cm_income[nellsw2$cm_income==14] <- 5750
nellsw2$cm_income[nellsw2$cm_income==15] <- 6500
nellsw2$cm_income[nellsw2$cm_income==16] <- 7500
nellsw2$cm_income[nellsw2$cm_income==17] <- NA
# let us scale the variable a bit and translate into income per 1000euro
nellsw2$cm_income <- nellsw2$cm_income/1000

#from household income to personal income
attributes(nellsw2$w2fa62)
table(nellsw2$w2fa62, useNA="always")
nellsw2$cm_income_per <- nellsw2$w2fa62
nellsw2$cm_income_per[nellsw2$cm_income_per==1] <- 0
nellsw2$cm_income_per[nellsw2$cm_income_per==2] <- 10
nellsw2$cm_income_per[nellsw2$cm_income_per==3] <- 20
nellsw2$cm_income_per[nellsw2$cm_income_per==4] <- 30
nellsw2$cm_income_per[nellsw2$cm_income_per==5] <- 40
nellsw2$cm_income_per[nellsw2$cm_income_per==6] <- 50
nellsw2$cm_income_per[nellsw2$cm_income_per==7] <- 60
nellsw2$cm_income_per[nellsw2$cm_income_per==8] <- 70
nellsw2$cm_income_per[nellsw2$cm_income_per==9] <- 80
nellsw2$cm_income_per[nellsw2$cm_income_per==10] <- 90
nellsw2$cm_income_per[nellsw2$cm_income_per==11] <- 100
nellsw2$cm_income_per[nellsw2$cm_income_per==12] <- NA

nellsw2$cm_income_ind <- nellsw2$cm_income * nellsw2$cm_income_per/100

#as an indicator of educational success we will use highest completed level of education in years.
#the rationale behind this coding this I will take the maximum for university as 16.5 (taking into account that some masters are 2 years and some 1 year) and subsequently subtract the years needed to obtain a university degree given the degree under consideration. 

attributes(nellsw2$w2fa102)
table(nellsw2$w2fa102, useNA="always")
nellsw2$cm_education <- nellsw2$w2fa102
nellsw2$cm_education[nellsw2$w2fa102==1] <- 6
nellsw2$cm_education[nellsw2$w2fa102==2] <- 9
nellsw2$cm_education[nellsw2$w2fa102==3] <- 10
nellsw2$cm_education[nellsw2$w2fa102==4] <- 11
nellsw2$cm_education[nellsw2$w2fa102==5] <- 12
nellsw2$cm_education[nellsw2$w2fa102==6] <- 10
nellsw2$cm_education[nellsw2$w2fa102==7] <- 11
nellsw2$cm_education[nellsw2$w2fa102==8] <- 14
nellsw2$cm_education[nellsw2$w2fa102==9] <- 15
nellsw2$cm_education[nellsw2$w2fa102==10] <- 16.5
nellsw2$cm_education[nellsw2$w2fa102==11] <- 16.5
nellsw2$cm_education[nellsw2$w2fa102==12] <- 7
nellsw2$cm_education[nellsw2$w2fa102==13] <- 11
nellsw2$cm_education[nellsw2$w2fa102==14] <- 14.5
nellsw2$cm_education[nellsw2$w2fa102==15] <- 4



#mean centering
nellsw2$cm_education_c <- nellsw2$cm_education - mean(nellsw2$cm_education, na.rm = T)
nellsw2$cm_age_c <- nellsw2$w1cage - mean(nellsw2$w1cage, na.rm = T)

#define a dichotemous moderator based on age. 
nellsw2$cm_old_d <- ifelse(nellsw2$cm_age_c>=0, 1, 0)


#as an indicator of health we will use subjective well being from 5 (excellent) to 1 (bad) thus we have to reverse code original variable
attributes(nellsw2$w2scf1)
table(nellsw2$w2scf1, useNA="always")
nellsw2$cm_health <- 6 - nellsw2$w2scf1

```
### lme4  

And test the model with **lme4**.

```{r, echo=FALSE, eval=FALSE}
require(lme4)
model0 <- lmer(cm_health ~ 1 + w2cdistrict2012P_LAAGINKP +  (1|w2cmun2012id), data = nellsw2)
summary(model0)

```

### Lavaan  

And test the model with **lavaan**.

```{r, echo=FALSE, eval=FALSE}
require(lavaan)

#empty random intercept model
model0 <- '
  #within 
  level: 1
    w2fk2 ~ cm_education_c
    w2fk2 ~~ w2fk2
    
  #between
  level: 2
    w2fk2 ~ 1 #random intercept
    w2fk2 ~~ w2fk2
'

fit0 <- lavaan(model0, data = nellsw2, cluster="w2cdistrict2012id") 
summary(fit0, standardized=TRUE)
lavInspect(fit0, "h1")
lavInspect(fit0, "icc")
```
### MPlus

And test the model with **MPlus**.




let op mplusautomation werkt niet met tibbles!!

```{r}
require(MplusAutomation)
library(texreg)

testdata <- data.frame(nellsw2[, c("w2cdistrict2012id", "w2fk2", "cm_education_c")])
testdata <- na.omit(testdata)
testdata$w2fk2 <- as.numeric(testdata$w2fk2)
testdata$cm_education_c <- as.numeric(testdata$cm_education_c)

mplusm0 <- mplusObject(
  TITLE = "ML empty model;", 
  VARIABLE = "CLUSTER = w2cdistrict2012id; MISSING = NA",
  ANALYSIS = "TYPE = TWOLEVEL RANDOM; ESTIMATOR=MLF;",
  MODEL = "
  %WITHIN%
  w2fk2 on cm_education_c;
  %BETWEEN%
  w2fk2 on cm_education_c;", 
  usevariables = c("w2cdistrict2012id", "w2fk2", "cm_education_c"),
  rdata = testdata[, c("w2cdistrict2012id", "w2fk2", "cm_education_c")]
  )

resmplusm3 <- mplusModeler(mplusm0, modelout = "mplusm0.inp", run = 1L, check = TRUE)
test <- readModels()
#summary(test)
#test$parameters
#test$summaries

screenreg(test, digits=3, single.row = T, summaries = c("Observations", "Parameters"), custom.model.names = test[[1]]$title)
test$data_summary 

testje <- read.delim("mplusm0.out", sep="\t")
print(testje)
```

<!--

```{r}
require(lavaan)
w2fk2
#empty random intercept model
model0 <- '
  #within 
  level: 1
    cm_health ~~ cm_health
  #between
  level: 2
    cm_health ~ 1 #random intercept
    cm_health ~~ cm_health
'

fit0 <- lavaan(model0, data = nellsw2, cluster="w2cmun2012id") 
summary(fit0, standardized=TRUE)
lavInspect(fit0, "h1")
lavInspect(fit0, "icc")
```

```{r}
#within-level covariate
model1 <- '
  #within 
  level: 1
    cm_health ~ cm_education_c
    cm_health ~~ cm_health
  #between
  level: 2
    cm_health ~ 1 #random intercept
    cm_health ~ cm_education_c
    cm_health ~~ cm_health
'

fit1 <- lavaan(model1, data = nellsw2, cluster="w2cmun2012id") 
summary(fit1, standardized=TRUE)
lavInspect(fit1, "h1")
lavInspect(fit0, "icc")

#cm_health ~ cm_education_c

```

---> 

We would conclude that SWB does not vary between municipalities.   

---  

## References  



